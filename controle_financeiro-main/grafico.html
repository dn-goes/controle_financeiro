<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Relat√≥rios ‚Äî Controle Financeiro</title>
  
  <link rel="stylesheet" href="grafico.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  
  <header class="navbar">
    <div class="container nav-content">
      <h1 class="logo">üí∞ Controle Financeiro</h1>
      <nav>
        <a href="index.html">üè† In√≠cio</a>
        <a href="grafico.html">üìà Gr√°fico</a>
        <a href="dividas.html">üí≥ D√≠vidas</a>
        <a href="saldo.html" class="ativo">üí∞ Saldo</a>
        <a href="login.html">Login</a>
        <a href="apoio.html">Apoio</a>
      </nav>
    </div>
  </header>

  <main class="container">
    
    <section class="report-header">
      <h2>üìä Painel de Relat√≥rios</h2>
      <div class="filter-group">
        <span>Per√≠odo:</span>
        <button class="filter-btn" data-meses="3">3 Meses</button>
        <button class="filter-btn active" data-meses="6">6 Meses</button> <button class="filter-btn" data-meses="12">12 Meses</button>
      </div>
    </section>

    <div class="empty-state" id="emptyState">
      <h3>üòï Nenhum dado encontrado</h3>
      <p>Parece que voc√™ ainda n√£o tem transa√ß√µes. Adicione novas receitas ou despesas nas outras p√°ginas para ver seus relat√≥rios aqui.</p>
    </div>

    <div class="report-grid" id="reportGrid">
      
      <section class="card">
        <h2>Maiores Despesas (Per√≠odo)</h2>
        <div class="chart-container">
          <canvas id="topExpensesBarChart"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Categorias de Sa√≠das (Vis√£o %)</h2>
        <div class="chart-container">
          <canvas id="categoryDoughnutChart"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Resumo do Per√≠odo</h2>
        <div class="estat-grid">
          <div>
            <span>Receita Total (Per√≠odo):</span>
            <b id="metricaReceitaTotal">R$ 0,00</b>
          </div>
          <div>
            <span>Despesa Total (Per√≠odo):</span>
            <b id="metricaDespesaTotal">R$ 0,00</b>
          </div>
          <div>
            <span>Balan√ßo (Receita - Despesa):</span>
            <b id="metricaBalancoTotal">R$ 0,00</b>
          </div>
          <div>
            <span>Taxa de Poupan√ßa:</span>
            <b id="metricaTaxaPoupanca">0%</b>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Resumo de D√≠vidas</h2>
        <div class="estat-grid">
          <div>
            <span>Total em D√≠vidas Ativas:</span>
            <b id="dividaTotalAtiva">R$ 0,00</b>
          </div>
          <div>
            <span>Total de D√≠vidas Pagas:</span>
            <b id="dividaTotalPaga">R$ 0,00</b>
          </div>
          <div>
            <span>Total de Itens (Ativas):</span>
            <b id="dividaContagemAtiva">0</b>
          </div>
          <div>
            <span>Total de Itens (Pagas):</span>
            <b id="dividaContagemPaga">0</b>
          </div>
        </div>
      </section>

    </div>
  </main>

  <footer class="site-footer">
    <p>Desenvolvido por <b>Daniel</b>, <b>Laiza</b> e <b>Gleice</b> ‚Äî 2025</p>
  </footer>

  <script>
    // Vari√°veis globais para os gr√°ficos
    let topExpensesBarChart = null; // <- MUDAN√áA: Substitui o monthlyBarChart
    let categoryDoughnutChart = null;

    // --- FUN√á√ÉO PRINCIPAL DE CARREGAMENTO ---

    document.addEventListener("DOMContentLoaded", () => {
      // 1. Gera dados de exemplo (mock) se o localStorage estiver vazio
      verificarEMockarDados();

      // 2. Carrega o relat√≥rio com o per√≠odo padr√£o (6 meses)
      carregarRelatorio(6);

      // 3. Adiciona 'click' aos bot√µes de filtro
      document.querySelectorAll(".filter-btn").forEach(button => {
        button.addEventListener("click", () => {
          document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
          button.classList.add("active");
          const meses = parseInt(button.dataset.meses);
          carregarRelatorio(meses);
        });
      });
    });

    /**
     * Fun√ß√£o central que busca dados e atualiza todos os elementos da p√°gina.
     */
    function carregarRelatorio(numMeses) {
      // Busca todos os dados necess√°rios
      const transacoes = JSON.parse(localStorage.getItem("transacoes")) || [];
      const dividas = JSON.parse(localStorage.getItem("dividas")) || [];
      const dividasPagas = JSON.parse(localStorage.getItem("dividasPagas")) || [];

      // --- Verifica√ß√£o de Estado Vazio ---
      if (transacoes.length === 0) {
        mostrarEstadoVazio(true);
        atualizarResumoDividas(dividas, dividasPagas);
        return; 
      }
      mostrarEstadoVazio(false);

      // --- Processamento de Dados ---
      // 1. Processa os dados das categorias de sa√≠da
      const dadosCategorias = processarCategorias(transacoes, numMeses);
      
      // 2. Separa os labels (nomes) e data (valores)
      const labels = dadosCategorias.map(d => d.label);
      const data = dadosCategorias.map(d => d.valor);
      
      // --- Renderiza√ß√£o ---
      // 1. Renderiza o NOVO gr√°fico de barras horizontais
      renderizarTopExpensesBarChart(labels, data);
      
      // 2. Renderiza o gr√°fico de rosca (pizza)
      renderizarGraficoCategorias(labels, data);
      
      // 3. Atualiza os cards de m√©tricas (com a l√≥gica simplificada)
      atualizarMetricas(transacoes, numMeses);

      // 4. Atualiza o resumo de d√≠vidas
      atualizarResumoDividas(dividas, dividasPagas);
    }

    /**
     * Controla a exibi√ß√£o da mensagem de "Estado Vazio"
     */
    function mostrarEstadoVazio(isVazio) {
      const emptyEl = document.getElementById('emptyState');
      const gridEl = document.getElementById('reportGrid');
      
      if (isVazio) {
        emptyEl.style.display = 'block';
        gridEl.style.display = 'none';
      } else {
        emptyEl.style.display = 'none';
        gridEl.style.display = 'grid';
      }
    }


    // --- FUN√á√ïES DE PROCESSAMENTO DE DADOS ---

    /**
     * Processa as categorias de SA√çDA do per√≠odo.
     * AGORA ELA TAMB√âM ORDENA O RESULTADO.
     * @returns {Array} - Um array de objetos ordenado, ex: [{label: "Moradia", valor: 1200}, {label: "Lazer", valor: 300}]
     */
    function processarCategorias(transacoes, numMeses) {
      const categorias = {};
      const hoje = new Date();
      const dataInicioPeriodo = new Date(hoje.getFullYear(), hoje.getMonth() - numMeses + 1, 1);

      // 1. Agrupa as transa√ß√µes por categoria
      for (const transacao of transacoes) {
        const dataTransacao = new Date(transacao.data);

        if (transacao.tipo === 'saida' && dataTransacao >= dataInicioPeriodo) {
          const cat = transacao.categoria || 'Outros';
          if (!categorias[cat]) {
            categorias[cat] = 0;
          }
          categorias[cat] += transacao.valor;
        }
      }
      
      // 2. Converte o objeto para um array
      const arrayCategorias = Object.keys(categorias).map(label => {
        return { label: label, valor: categorias[label] };
      });

      // 3. ORDENA o array do maior valor para o menor
      arrayCategorias.sort((a, b) => b.valor - a.valor);
      
      return arrayCategorias;
    }


    // --- FUN√á√ïES DE RENDERIZA√á√ÉO (GR√ÅFICOS) ---

    /**
     * [NOVO] Renderiza o Gr√°fico de Barras Horizontais com as Maiores Despesas
     */
    function renderizarTopExpensesBarChart(labels, data) {
      const ctx = document.getElementById('topExpensesBarChart').getContext('2d');
      
      if (topExpensesBarChart) {
        topExpensesBarChart.destroy();
      }

      // Se n√£o houver dados, exibe uma mensagem
      if (data.length === 0) {
        data = [1];
        labels = ["Nenhuma sa√≠da no per√≠odo"];
      }
      
      topExpensesBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Gasto (R$)',
            data: data,
            backgroundColor: 'var(--primary-blue)',
            borderRadius: 4,
          }]
        },
        options: {
          indexAxis: 'y', // <-- ISSO FAZ O GR√ÅFICO SER HORIZONTAL
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { beginAtZero: true, ticks: { color: 'var(--text-secondary)' } },
            y: { ticks: { color: 'var(--text-secondary)' } }
          },
          plugins: {
            legend: { // Esconde a legenda, pois s√≥ tem 1 dataset
              display: false 
            }
          }
        }
      });
    }

    /**
     * Renderiza o Gr√°fico de Rosca (Categorias %)
     */
    function renderizarGraficoCategorias(labels, data) {
      const ctx = document.getElementById('categoryDoughnutChart').getContext('2d');
      
      if (categoryDoughnutChart) {
        categoryDoughnutChart.destroy();
      }
      
      // Se n√£o houver dados
      if (data.length === 0) {
        data = [1];
        labels = ["Nenhuma sa√≠da no per√≠odo"];
        const backgroundColors = ['#4a506e']; 
        
        categoryDoughnutChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{ data: data, backgroundColor: backgroundColors, borderColor: 'var(--card-bg)', borderWidth: 4 }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: true, position: 'bottom', labels: { color: 'var(--text-primary)', font: { size: 14 } } }
            }
          }
        });
        return; 
      }

      // Se houver dados, usa as cores normais
      const backgroundColors = ['#1e88e5', '#e53935', '#f57c00', '#43a047', '#ffb300', '#6d4c41'];
      
      categoryDoughnutChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderColor: 'var(--card-bg)',
            borderWidth: 4,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: 'var(--text-primary)', font: { size: 14 } }
            }
          }
        }
      });
    }

    // --- FUN√á√ïES DE ATUALIZA√á√ÉO (M√âTRICAS) ---

    function formatCurrency(value) {
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    /**
     * [MODIFICADO] Atualiza os cards de "M√©tricas Chave" com totais do per√≠odo.
     */
    function atualizarMetricas(transacoes, numMeses) {
      const hoje = new Date();
      const dataInicioPeriodo = new Date(hoje.getFullYear(), hoje.getMonth() - numMeses + 1, 1);

      let totalEntradas = 0;
      let totalSaidas = 0;

      // Filtra transa√ß√µes do per√≠odo e soma
      for (const transacao of transacoes) {
        const dataTransacao = new Date(transacao.data);
        if (dataTransacao >= dataInicioPeriodo) {
          if (transacao.tipo === 'entrada') {
            totalEntradas += transacao.valor;
          } else if (transacao.tipo === 'saida') {
            totalSaidas += transacao.valor;
          }
        }
      }

      const balancoTotal = totalEntradas - totalSaidas;
      
      // Calcula taxa de poupan√ßa (evita divis√£o por zero)
      let taxaPoupanca = 0;
      if (totalEntradas > 0) {
        taxaPoupanca = (balancoTotal / totalEntradas) * 100;
      }

      // Atualiza o HTML
      document.getElementById('metricaReceitaTotal').textContent = formatCurrency(totalEntradas);
      document.getElementById('metricaDespesaTotal').textContent = formatCurrency(totalSaidas);
      
      const balancoEl = document.getElementById('metricaBalancoTotal');
      balancoEl.textContent = formatCurrency(balancoTotal);
      balancoEl.className = balancoTotal >= 0 ? 'positivo' : 'negativo';
      
      // Garante que a taxa de poupan√ßa n√£o seja negativa (se gastou mais que ganhou, √© 0%)
      document.getElementById('metricaTaxaPoupanca').textContent = `${Math.max(0, taxaPoupanca).toFixed(0)}%`;
    }

    /**
     * Atualiza o card "Resumo de D√≠vidas" (sem altera√ß√µes)
     */
    function atualizarResumoDividas(dividas, dividasPagas) {
      const totalAtivas = dividas.reduce((acc, div) => acc + (div.valor || 0), 0);
      const totalPagas = dividasPagas.reduce((acc, div) => acc + (div.valor || 0), 0);

      document.getElementById('dividaTotalAtiva').textContent = formatCurrency(totalAtivas);
      document.getElementById('dividaTotalPaga').textContent = formatCurrency(totalPagas);
      document.getElementById('dividaContagemAtiva').textContent = dividas.length;
      document.getElementById('dividaContagemPaga').textContent = dividasPagas.length;
    }

    // --- FUN√á√ÉO DE MOCK DE DADOS (PARA TESTE) ---

    /**
     * Cria dados fict√≠cios no localStorage se n√£o houverem dados.
     * (Sem altera√ß√µes)
     */
    function verificarEMockarDados() {
      // S√≥ cria dados MOCK se 'transacoes' N√ÉO existir
      if (!localStorage.getItem('transacoes')) {
        console.warn("Nenhuma transa√ß√£o encontrada. Criando dados MOCK...");
        
        const transacoesMock = [];
        const categoriasMock = ['Moradia', 'Transporte', 'Alimenta√ß√£o', 'Lazer', 'Sa√∫de'];
        const hoje = new Date();
        let idCounter = 1;

        for (let mes = 12; mes >= 0; mes--) { // 12 meses de dados
          transacoesMock.push({
            id: idCounter++,
            data: new Date(hoje.getFullYear(), hoje.getMonth() - mes, 1).toISOString(),
            tipo: 'entrada',
            valor: 3500 + Math.random() * 500,
            categoria: 'Sal√°rio',
            descricao: 'Sal√°rio Mensal'
          });
          
          for (let i = 0; i < 12; i++) {
            const dia = Math.floor(Math.random() * 28) + 1;
            const categoria = categoriasMock[Math.floor(Math.random() * categoriasMock.length)];
            transacoesMock.push({
              id: idCounter++,
              data: new Date(hoje.getFullYear(), hoje.getMonth() - mes, dia).toISOString(),
              tipo: 'saida',
              valor: Math.random() * 150 + 20,
              categoria: categoria,
              descricao: `Compra em ${categoria}`
            });
          }
        }
        localStorage.setItem('transacoes', JSON.stringify(transacoesMock));
      }

      if (!localStorage.getItem('dividas')) {
        const dividasMock = [
          { id: 1, nome: 'Cart√£o Nubank', valor: 850.70, vencimento: '2025-11-20' },
          { id: 2, nome: 'Financiamento Apto', valor: 1200.00, vencimento: '2025-11-10' }
        ];
        localStorage.setItem('dividas', JSON.stringify(dividasMock));

        // Tamb√©m cria um resumo financeiro mock
        const resumoMock = { saldo: 500, entradas: 3500, saidas: 3000 };
        localStorage.setItem('resumoFinanceiro', JSON.stringify(resumoMock));
      }

      if (!localStorage.getItem('dividasPagas')) {
        const dividasPagasMock = [
          { id: 3, nome: 'Cart√£o Inter', valor: 430.20, vencimento: '2025-10-20' }
        ];
        localStorage.setItem('dividasPagas', JSON.stringify(dividasPagasMock));
      }
    }
  </script>
</body>
</html>